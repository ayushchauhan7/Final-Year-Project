<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Tumor Detection System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            border-radius: 15px;
            margin-bottom: 20px;
        }

        #results img, #api-results img, #debug-results img {
            max-height: 400px;
            margin-top: 15px;
        }

        .text-center {
            text-align: center;
        }

        .btn {
            width: 100%;
            margin-bottom: 10px;
        }

        .lead {
            margin-bottom: 30px;
        }

        .api-section {
            border-left: 4px solid #007bff;
            padding-left: 15px;
        }

        .debug-section {
            border-left: 4px solid #28a745;
            padding-left: 15px;
        }

        /* Enhanced JSON output styling */
        .json-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .json-output pre {
            margin: 0;
            background: none;
            border: none;
            padding: 0;
            font-size: inherit;
        }

        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
        }

        /* Chart display enhancements */
        #charts-display .card {
            transition: transform 0.2s ease-in-out;
        }

        #charts-display .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* Statistics summary cards */
        #statistics-summary .card {
            min-height: 80px;
            display: flex;
            align-items: center;
        }

        /* Results sections styling */
        #charts-results, #statistics-results {
            transition: all 0.3s ease;
        }

        .card-title {
            margin-bottom: 1rem;
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .json-output {
                font-size: 10px;
                max-height: 200px;
            }
            
            #charts-display .card-body img {
                max-height: 200px !important;
            }
        }

        /* Prevent accidental form submissions */
        form {
            position: relative;
        }

        form[onsubmit="return false;"] {
            /* Visual indicator that form won't submit */
            border-left: 3px solid #28a745;
            padding-left: 10px;
        }

        /* Ensure all buttons are properly styled */
        button[type="button"] {
            cursor: pointer;
        }

        /* Preserve tab content */
        .tab-content {
            min-height: 500px;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <div class="text-center">
            <h1 class="display-4 text-primary">Brain Tumor Detection System</h1>
            <p class="lead text-secondary">Comprehensive test interface for all endpoints</p>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="web-tab" data-bs-toggle="tab" data-bs-target="#web" type="button">Web Interface</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button">API Predict</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="debug-tab" data-bs-toggle="tab" data-bs-target="#debug" type="button">Debug API</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch" type="button">Batch API</button>
            </li>
            <!-- Add this new tab in the navigation -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" type="button">Research Results</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Web Interface Tab - FIXED VERSION -->
            <div class="tab-pane fade show active" id="web-interface" role="tabpanel">
                <div class="card shadow p-4 mt-4" style="border-left: 4px solid #007bff;">
                    <h4 class="text-primary">🧠 Brain Tumor Analysis</h4>
                    <p class="text-muted">Upload an MRI scan image for AI-powered tumor detection</p>
                    
                    <!-- PREVENT FORM SUBMISSION RELOAD -->
                    <form id="web-upload-form" onsubmit="return false;"> <!-- Added onsubmit="return false;" -->
                        <div class="mb-3">
                            <label for="web-file" class="form-label">Select MRI Image:</label>
                            <input type="file" class="form-control" id="web-file" accept="image/*" required>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="analyzeWebImage()"> <!-- Changed to type="button" -->
                            <span id="web-spinner" class="spinner-border spinner-border-sm d-none"></span>
                            Analyze Image
                        </button>
                    </form>
                </div>

                <!-- Results section remains the same -->
                <div id="web-results" class="mt-4" style="display: none;">
                    <div class="card shadow">
                        <div class="card-body">
                            <h4 class="card-title text-primary">🎯 Analysis Results</h4>
                            <div id="web-image-preview" class="mb-3"></div>
                            <div id="web-json" class="json-output"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Predict Tab -->
            <div class="tab-pane fade" id="api" role="tabpanel">
                <div class="card shadow p-4 mt-4 api-section">
                    <h4 class="text-primary">API Predict Endpoint</h4>
                    <p class="text-muted">Test <code>/api/predict</code> endpoint with AJAX</p>
                    <form id="api-form">
                        <div class="mb-3">
                            <label for="api-file" class="form-label">Select MRI Image:</label>
                            <input type="file" class="form-control" id="api-file" accept="image/*" required>
                        </div>
                        <button type="button" class="btn btn-info" onclick="testApiPredict()">
                            <span id="api-spinner" class="spinner-border spinner-border-sm d-none"></span>
                            Test API Predict
                        </button>
                    </form>
                </div>

                <!-- API Results -->
                <div id="api-results" class="mt-4" style="display: none;">
                    <div class="card shadow">
                        <div class="card-body">
                            <h4 class="card-title text-info">API Response</h4>
                            <div id="api-json" class="json-output"></div>
                            <div id="api-image-preview" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Debug API Tab -->
            <div class="tab-pane fade" id="debug" role="tabpanel">
                <div class="card shadow p-4 mt-4 debug-section">
                    <h4 class="text-success">Debug Prediction Endpoint</h4>
                    <p class="text-muted">Test <code>/api/debug/prediction</code> with detailed analysis</p>
                    <form id="debug-form">
                        <div class="mb-3">
                            <label for="debug-file" class="form-label">Select MRI Image:</label>
                            <input type="file" class="form-control" id="debug-file" accept="image/*" required>
                        </div>
                        <button type="button" class="btn btn-success" onclick="testDebugPredict()">
                            <span id="debug-spinner" class="spinner-border spinner-border-sm d-none"></span>
                            Test Debug Prediction
                        </button>
                    </form>
                </div>

                <!-- Debug Results -->
                <div id="debug-results" class="mt-4" style="display: none;">
                    <div class="card shadow">
                        <div class="card-body">
                            <h4 class="card-title text-success">Debug Response</h4>
                            <div id="debug-json" class="json-output"></div>
                            <div id="debug-image-preview" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Batch API Tab -->
            <div class="tab-pane fade" id="batch" role="tabpanel">
                <div class="card shadow p-4 mt-4" style="border-left: 4px solid #fd7e14;">
                    <h4 class="text-warning">📚 Batch Prediction Endpoint</h4>
                    <p class="text-muted">Test <code>/api/predict/batch</code> endpoint with multiple images</p>
                    <form id="batch-form">
                        <div class="mb-3">
                            <label for="batch-files" class="form-label">Select Multiple MRI Images:</label>
                            <input type="file" class="form-control" id="batch-files" accept="image/*" multiple required>
                            <small class="text-muted">Hold Ctrl/Cmd to select multiple images</small>
                        </div>
                        <button type="button" class="btn btn-warning" onclick="testBatchPredict()">
                            <span id="batch-spinner" class="spinner-border spinner-border-sm d-none"></span>
                            Test Batch Prediction
                        </button>
                    </form>
                </div>

                <!-- Batch Results -->
                <div id="batch-results" class="mt-4" style="display: none;">
                    <div class="card shadow">
                        <div class="card-body">
                            <h4 class="card-title text-warning">📊 Batch Response</h4>
                            <div id="batch-json" class="json-output"></div>
                            <div id="batch-image-preview" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Research Results Tab - ENHANCED VERSION -->
            <div class="tab-pane fade" id="results" role="tabpanel">
                <div class="card shadow p-4 mt-4" style="border-left: 4px solid #28a745;">
                    <h4 class="text-success">📊 Research Results & Analytics</h4>
                    <p class="text-muted">Test research endpoints for charts and statistical analysis</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5>📈 Charts Generation</h5>
                            <p><code>/api/results/charts</code> - Generate research visualizations</p>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success" onclick="testChartsGeneration()">
                                    <span id="charts-spinner" class="spinner-border spinner-border-sm d-none"></span>
                                    Generate Research Charts
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="refreshCharts()">
                                    🔄 Refresh Charts
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>📊 Statistical Analysis</h5>
                            <p><code>/api/results/statistics</code> - Get detailed statistics</p>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-info" onclick="testStatisticsGeneration()">
                                    <span id="stats-spinner" class="spinner-border spinner-border-sm d-none"></span>
                                    Generate Statistics
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="refreshStatistics()">
                                    🔄 Refresh Statistics
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Note:</strong> Charts and statistics are preserved when switching tabs. Use refresh buttons to get updated data after making new predictions.
                        </small>
                    </div>
                </div>

                <!-- Charts Results Section -->
                <div id="charts-results" class="mt-4" style="display: none;">
                    <div class="card shadow">
                        <div class="card-body">
                            <h4 class="card-title text-success">📊 Generated Charts</h4>
                            <div id="charts-display" class="row mb-4"></div>
                            <div class="mt-3">
                                <h5>Raw JSON Response:</h5>
                                <div id="charts-json" class="json-output"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Results Section -->
                <div id="statistics-results" class="mt-4" style="display: none;">
                    <div class="card shadow">
                        <div class="card-body">
                            <h4 class="card-title text-info">📈 Statistical Analysis</h4>
                            <div id="statistics-json" class="json-output"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick API Info -->
        <div class="card shadow p-4 mt-4">
            <h5 class="text-secondary">Quick API Reference</h5>
            <div class="row">
                <div class="col-md-4">
                    <strong>Standard Endpoints:</strong>
                    <ul class="list-unstyled mt-2">
                        <li><code>GET /</code> - API Documentation</li>
                        <li><code>GET /api/health</code> - Health Check</li>
                        <li><code>GET /api/classes</code> - Available Classes</li>
                        <li><code>GET /api/model/info</code> - Model Info</li>
                        <li><code>GET /api/analytics/summary</code> - Analytics</li>
                        <li><code>GET /api/predictions/history</code> - History</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <strong>POST Endpoints:</strong>
                    <ul class="list-unstyled mt-2">
                        <li><code>POST /api/predict</code> - Single Image</li>
                        <li><code>POST /api/predict/batch</code> - Multiple Images</li>
                        <li><code>POST /api/debug/prediction</code> - Debug Analysis</li>
                    </ul>
                    <strong>Research Endpoints:</strong> <!-- New -->
                    <ul class="list-unstyled mt-2">
                        <li><code>GET /api/results/charts</code> - Research Charts</li>
                        <li><code>GET /api/results/statistics</code> - Statistics</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <strong>Test These Endpoints:</strong>
                    <div class="d-grid gap-1">
                        <button class="btn btn-sm btn-outline-primary" onclick="testEndpoint('/api/health')">Test Health</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="testEndpoint('/api/classes')">Test Classes</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="testEndpoint('/api/model/info')">Test Model Info</button>
                        <button class="btn btn-sm btn-outline-success" onclick="testEndpoint('/api/results/statistics')">Test Statistics</button> <!-- New -->
                        <button class="btn btn-sm btn-outline-info" onclick="testChartsGeneration()">Generate Charts</button> <!-- New -->
                    </div>
                </div>
            </div>
            <div id="quick-test-results" class="mt-3" style="display: none;">
                <div class="json-output" id="quick-json"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Test API Predict endpoint
        function testApiPredict() {
            const fileInput = document.getElementById('api-file');
            const spinner = document.getElementById('api-spinner');
            const resultsDiv = document.getElementById('api-results');
            const jsonDiv = document.getElementById('api-json');
            const imageDiv = document.getElementById('api-image-preview');

            if (!fileInput.files[0]) {
                alert('Please select an image file first!');
                return;
            }

            // Show loading
            spinner.classList.remove('d-none');
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            fetch('/api/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading
                spinner.classList.add('d-none');
                
                // Show results
                resultsDiv.style.display = 'block';
                jsonDiv.textContent = JSON.stringify(data, null, 2);
                
                // Show image preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageDiv.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded" alt="Uploaded Image" style="max-height: 300px;">`;
                };
                reader.readAsDataURL(fileInput.files[0]);
                
                // IMPORTANT: Don't reload the page or reset other tabs
            })
            .catch(error => {
                spinner.classList.add('d-none');
                jsonDiv.textContent = `Error: ${error.message}`;
                resultsDiv.style.display = 'block';
            });
        }

        // Test Debug Prediction endpoint
        function testDebugPredict() {
            const fileInput = document.getElementById('debug-file');
            const spinner = document.getElementById('debug-spinner');
            const resultsDiv = document.getElementById('debug-results');
            const jsonDiv = document.getElementById('debug-json');
            const imageDiv = document.getElementById('debug-image-preview');

            if (!fileInput.files[0]) {
                alert('Please select an image file first!');
                return;
            }

            // Show loading
            spinner.classList.remove('d-none');
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            fetch('/api/debug/prediction', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading
                spinner.classList.add('d-none');
                
                // Show results
                resultsDiv.style.display = 'block';
                jsonDiv.textContent = JSON.stringify(data, null, 2);
                
                // Show image preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageDiv.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded" alt="Uploaded Image" style="max-height: 300px;">`;
                };
                reader.readAsDataURL(fileInput.files[0]);
            })
            .catch(error => {
                spinner.classList.add('d-none');
                jsonDiv.textContent = `Error: ${error.message}`;
                resultsDiv.style.display = 'block';
            });
        }

        // FIXED - Enhanced Batch Prediction with Image Previews
        function testBatchPredict() {
            const fileInput = document.getElementById('batch-files');
            const spinner = document.getElementById('batch-spinner');
            const resultsDiv = document.getElementById('batch-results');
            const jsonDiv = document.getElementById('batch-json');
            const imageDiv = document.getElementById('batch-image-preview');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select multiple image files first!');
                return;
            }

            // Show loading
            spinner.classList.remove('d-none');
            
            // Show image previews immediately while processing
            showImagePreviews(fileInput.files, imageDiv);
            
            const formData = new FormData();
            
            // Append all selected files
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('images', fileInput.files[i]);
            }

            fetch('/api/predict/batch', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {  // FIXED: Added missing arrow function syntax
                // Hide loading
                spinner.classList.add('d-none');
                
                // Show results
                resultsDiv.style.display = 'block';
                jsonDiv.textContent = JSON.stringify(data, null, 2);
                
                // Update images with results
                showImagePreviewsWithResults(fileInput.files, data, imageDiv);
            })  // FIXED: Added missing semicolon
            .catch(error => {
                spinner.classList.add('d-none');
                jsonDiv.textContent = `Error: ${error.message}`;
                resultsDiv.style.display = 'block';
                
                // Show error
                imageDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>❌ Error processing images</h6>
                        <p>${error.message}</p>
                    </div>
                `;
            });
        }

        // Helper function to show image previews
        function showImagePreviews(files, containerDiv) {
            let previewHtml = `
                <h6>Processing ${files.length} images...</h6>
                <div class="row" id="image-preview-container">
            `;
            
            containerDiv.innerHTML = previewHtml;
            
            const maxPreviews = Math.min(files.length, 6);
            let loadedCount = 0;
            
            for (let i = 0; i < maxPreviews; i++) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageHtml = `
                        <div class="col-md-4 col-sm-6 mb-3" id="image-${i}">
                            <div class="card">
                                <img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;">
                                <div class="card-body p-2">
                                    <h6 class="card-title text-truncate" style="font-size: 0.8rem;">${files[i].name}</h6>
                                    <p class="card-text">
                                        <small class="text-muted">${(files[i].size / 1024).toFixed(1)} KB</small><br>
                                        <span class="badge bg-warning">Processing...</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('image-preview-container').innerHTML += imageHtml;
                    
                    loadedCount++;
                    if (loadedCount === maxPreviews) {
                        if (files.length > maxPreviews) {
                            document.getElementById('image-preview-container').innerHTML += `
                                <div class="col-12">
                                    <small class="text-muted">... and ${files.length - maxPreviews} more images</small>
                                </div>
                            `;
                        }
                        containerDiv.innerHTML += '</div>';
                    }
                };
                reader.readAsDataURL(files[i]);
            }
        }

        // Helper function to show previews with results
        function showImagePreviewsWithResults(files, apiResponse, containerDiv) {
            let previewHtml = `
                <h6>✅ Processed ${files.length} images - Results:</h6>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="alert alert-info p-2">
                            <strong>Total:</strong> ${apiResponse.total_images || files.length}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-danger p-2">
                            <strong>Tumors:</strong> ${apiResponse.batch_summary?.tumor_detected || 0}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-success p-2">
                            <strong>Normal:</strong> ${apiResponse.batch_summary?.no_tumor || 0}
                        </div>
                    </div>
                </div>
                <div class="row" id="result-preview-container">
            `;
            
            containerDiv.innerHTML = previewHtml;
            
            const maxPreviews = Math.min(files.length, 6);
            let loadedCount = 0;
            
            for (let i = 0; i < maxPreviews; i++) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Find corresponding result
                    const result = apiResponse.results ? apiResponse.results.find(r => r.filename === files[i].name) : null;
                    const prediction = result ? result.prediction : 'Unknown';
                    const confidence = result ? result.confidence : 'N/A';
                    const isTumor = prediction.includes('Tumor') && !prediction.includes('No Tumor');
                    
                    const imageHtml = `
                        <div class="col-md-4 col-sm-6 mb-3">
                            <div class="card ${isTumor ? 'border-danger' : 'border-success'}">
                                <img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;">
                                <div class="card-body p-2">
                                    <h6 class="card-title text-truncate" style="font-size: 0.8rem;" title="${files[i].name}">
                                        ${files[i].name}
                                </h6>
                                    <p class="card-text">
                                        <span class="badge ${isTumor ? 'bg-danger' : 'bg-success'}" style="font-size: 0.7rem;">
                                            ${prediction}
                                        </span><br>
                                        <small class="text-muted">Confidence: ${confidence}</small><br>
                                        <small class="text-muted">${(files[i].size / 1024).toFixed(1)} KB</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('result-preview-container').innerHTML += imageHtml;
                    
                    loadedCount++;
                    if (loadedCount === maxPreviews) {
                        if (files.length > maxPreviews) {
                            document.getElementById('result-preview-container').innerHTML += `
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <small>Showing first ${maxPreviews} of ${files.length} processed images. All results are included in the JSON response above.</small>
                                    </div>
                                </div>
                            `;
                        }
                        containerDiv.innerHTML += '</div>';
                    }
                };
                reader.readAsDataURL(files[i]);
            }
        }

        // Test other endpoints
        function testEndpoint(endpoint) {
            const resultsDiv = document.getElementById('quick-test-results');
            const jsonDiv = document.getElementById('quick-json');

            fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                resultsDiv.style.display = 'block';
                jsonDiv.textContent = JSON.stringify(data, null, 2);
            })
            .catch(error => {
                resultsDiv.style.display = 'block';
                jsonDiv.textContent = `Error: ${error.message}`;
            });
        }

        // FIXED - Test Charts Generation Function
        function testChartsGeneration() {
            const spinner = document.getElementById('charts-spinner');
            const resultsDiv = document.getElementById('charts-results');
            const chartsDisplay = document.getElementById('charts-display');
            const jsonDiv = document.getElementById('charts-json');

            // If charts were already generated and saved, restore them
            if (chartsGenerated && savedChartsData) {
                displaySavedCharts(savedChartsData);
                return;
            }

            // Show loading spinner
            spinner.classList.remove('d-none');
            
            // Clear previous results
            resultsDiv.style.display = 'none';
            chartsDisplay.innerHTML = '';
            jsonDiv.textContent = '';

            fetch('/api/results/charts')
            .then(response => response.json())
            .then(data => {
                // Hide loading spinner
                spinner.classList.add('d-none');
                
                // Save the data for later restoration
                savedChartsData = data;
                chartsGenerated = true;
                
                // Display the charts
                displaySavedCharts(data);
            })
            .catch(error => {
                // Hide loading spinner
                spinner.classList.add('d-none');
                
                // Show error in results section
                resultsDiv.style.display = 'block';
                jsonDiv.textContent = `Error: ${error.message}`;
                chartsDisplay.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <strong>Error generating charts:</strong> ${error.message}
                        </div>
                    </div>
                `;
            });
        }

        // Helper function to display saved charts
        function displaySavedCharts(data) {
            const resultsDiv = document.getElementById('charts-results');
            const chartsDisplay = document.getElementById('charts-display');
            const jsonDiv = document.getElementById('charts-json');
            
            // Show results section
            resultsDiv.style.display = 'block';
            
            // Display JSON response
            jsonDiv.textContent = JSON.stringify(data, null, 2);
            
            // Display charts if available
            if (data.charts && Object.keys(data.charts).length > 0) {
                let chartsHtml = '';
                Object.entries(data.charts).forEach(([chartName, chartBase64]) => {
                    const chartTitle = chartName.replace(/_/g, ' ').toUpperCase();
                    chartsHtml += `
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">${chartTitle}</h6>
                                </div>
                                <div class="card-body text-center">
                                    <img src="data:image/png;base64,${chartBase64}" 
                                         class="img-fluid" 
                                         alt="${chartTitle}"
                                         style="max-height: 300px; cursor: pointer;"
                                         onclick="openImageModal('${chartBase64}', '${chartTitle}')">
                                    <br>
                                    <small class="text-muted">Click to enlarge</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                chartsDisplay.innerHTML = chartsHtml;
            } else {
                chartsDisplay.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            No charts available. Make sure you have prediction history by using other tabs first.
                        </div>
                    </div>
                `;
            }
        }

        // FIXED - Test Statistics Generation Function
        function testStatisticsGeneration() {
            const spinner = document.getElementById('stats-spinner');
            const resultsDiv = document.getElementById('statistics-results');
            const jsonDiv = document.getElementById('statistics-json');

            // If statistics were already generated and saved, restore them
            if (statisticsGenerated && savedStatsData) {
                displaySavedStatistics(savedStatsData);
                return;
            }

            // Show loading spinner
            spinner.classList.remove('d-none');
            
            // Clear previous results
            resultsDiv.style.display = 'none';
            jsonDiv.textContent = '';

            fetch('/api/results/statistics')
            .then(response => response.json())
            .then(data => {
                // Hide loading spinner
                spinner.classList.add('d-none');
                
                // Save the data for later restoration
                savedStatsData = data;
                statisticsGenerated = true;
                
                // Display the statistics
                displaySavedStatistics(data);
            })
            .catch(error => {
                // Hide loading spinner
                spinner.classList.add('d-none');
                
                // Show error in results section
                resultsDiv.style.display = 'block';
                jsonDiv.textContent = `Error: ${error.message}`;
            });
        }

        // Helper function to display saved statistics
        function displaySavedStatistics(data) {
            const resultsDiv = document.getElementById('statistics-results');
            const jsonDiv = document.getElementById('statistics-json');
            
            // Show results section
            resultsDiv.style.display = 'block';
            
            // Display JSON response
            jsonDiv.textContent = JSON.stringify(data, null, 2);
        }

        // Add tab switching event listener to restore state
        document.addEventListener('DOMContentLoaded', function() {
            // Listen for tab switches
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(function(tab) {
                tab.addEventListener('shown.bs.tab', function(e) {
                    // If switching to results tab and we have saved data, restore it
                    if (e.target.getAttribute('data-bs-target') === '#results') {
                        setTimeout(() => {
                            if (chartsGenerated && savedChartsData) {
                                displaySavedCharts(savedChartsData);
                            }
                            if (statisticsGenerated && savedStatsData) {
                                displaySavedStatistics(savedStatsData);
                            }
                        }, 100);
                    }
                });
            });
        });

        // Add refresh buttons for charts and statistics
        function refreshCharts() {
            chartsGenerated = false;
            savedChartsData = null;
            testChartsGeneration();
        }

        function refreshStatistics() {
            statisticsGenerated = false;
            savedStatsData = null;
            testStatisticsGeneration();
        }

        // Helper function for image modal (keep existing if present)
        function openImageModal(base64Data, title) {
            // Create modal for chart enlargement
            const modalHtml = `
                <div class="modal fade" id="chartModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img src="data:image/png;base64,${base64Data}" class="img-fluid" alt="${title}">
                            </div>
                            <div class="modal-footer">
                                <a href="data:image/png;base64,${base64Data}" download="${title}.png" class="btn btn-success">
                                    Download Chart
                                </a>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('chartModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('chartModal'));
            modal.show();
        }

        // NEW - Web Interface Analysis Function (No Page Reload)
        function analyzeWebImage() {
            const fileInput = document.getElementById('web-file');
            const spinner = document.getElementById('web-spinner');
            const resultsDiv = document.getElementById('web-results');
            const jsonDiv = document.getElementById('web-json');
            const imageDiv = document.getElementById('web-image-preview');

            if (!fileInput.files || !fileInput.files[0]) {
                alert('Please select an MRI image file first!');
                return;
            }

            // Show loading
            spinner.classList.remove('d-none');
            
            // Clear previous results
            resultsDiv.style.display = 'none';
            jsonDiv.textContent = '';
            imageDiv.innerHTML = '';

            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            fetch('/api/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // DEBUG: Log the entire response
                console.log("Full API Response:", data);
                
                // Hide loading
                spinner.classList.add('d-none');
                
                // Show results
                resultsDiv.style.display = 'block';
                jsonDiv.textContent = JSON.stringify(data, null, 2);
                
                // Show image preview with enhanced styling
                const reader = new FileReader();
                reader.onload = function(e) {
                    const prediction = data.prediction || 'Unknown';
                    
                    // IMPROVED: Better confidence handling
                    let confidenceDisplay = 'N/A';
                    
                    // Try multiple possible confidence fields
                    let confidence = data.confidence || data.confidence_percentage;
                    
                    console.log("Confidence value:", confidence, "Type:", typeof confidence);  // DEBUG
                    
                    if (confidence !== undefined && confidence !== null && !isNaN(confidence)) {
                        if (data.confidence_percentage) {
                            // If backend sends percentage directly
                            confidenceDisplay = data.confidence_percentage.toFixed(1) + '%';
                        } else if (confidence <= 1) {
                            // If confidence is between 0-1, convert to percentage
                            confidenceDisplay = (confidence * 100).toFixed(1) + '%';
                        } else {
                            // If already in percentage format
                            confidenceDisplay = confidence.toFixed(1) + '%';
                        }
                    }
                    
                    const isTumor = prediction.includes('Tumor') && !prediction.includes('No Tumor');
                    
                    imageDiv.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <img src="${e.target.result}" 
                                     class="img-fluid rounded border" 
                                     alt="Uploaded MRI Scan" 
                                     style="max-height: 300px; width: 100%; object-fit: cover;">
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column justify-content-center h-100">
                                    <div class="alert ${isTumor ? 'alert-danger' : 'alert-success'} text-center">
                                        <h5 class="mb-2">🔬 Analysis Result</h5>
                                        <h4 class="${isTumor ? 'text-danger' : 'text-success'}">${prediction}</h4>
                                        <p class="mb-0">Confidence: <strong>${confidenceDisplay}</strong></p>
                                    </div>
                                    <small class="text-muted">
                                        <strong>File:</strong> ${fileInput.files[0].name}<br>
                                        <strong>Size:</strong> ${(fileInput.files[0].size / 1024).toFixed(1)} KB
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                };
                reader.readAsDataURL(fileInput.files[0]);
                
                // IMPORTANT: This won't affect other tabs since we're using fetch
                console.log('Analysis completed without page reload');
            })
            .catch(error => {
                console.error("API Error:", error);  // DEBUG
                spinner.classList.add('d-none');
                resultsDiv.style.display = 'block';
                jsonDiv.textContent = `Error: ${error.message}`;
                
                // Show error image preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageDiv.innerHTML = `
                        <div class="text-center">
                            <img src="${e.target.result}" 
                                 class="img-fluid rounded border" 
                                 alt="Uploaded Image" 
                                 style="max-height: 200px;">
                            <div class="alert alert-danger mt-3">
                                <strong>Analysis Failed:</strong> ${error.message}
                            </div>
                        </div>
                    `;
                };
                reader.readAsDataURL(fileInput.files[0]);
            });
        }

        // FIXED - Variable declarations at the top of script section
        let chartsGenerated = false;
        let statisticsGenerated = false;
        let savedChartsData = null;
        let savedStatsData = null;
    </script>
</body>
</html>